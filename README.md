# SMIS SSO workspace

This repository hosts two parts of the SMIS SSO effort:

1. `packages/smis-sso-client`: a reusable client library that applications use to discover or create an SMIS session, then fetch roles and permissions for their SMIS-issued application key.
2. `platform/auth-gateway`: a runnable NestJS scaffold that issues tokens, handles the SSO probe/login flow, and exposes authorization/profile APIs for `auth.smis.itc.edu.kh`.

## Getting started

```bash
npm install
npm run build
```

The client library expects an application key generated by SMIS (examples: `pp-#########`, `pp-gic-#########`, `tk-####`, `tk-gic-#########`) and the base URL of the auth portal (e.g., `https://auth.smis.itc.edu.kh`).

## Example SSO process flow

1. **Application boot**: Provide your SMIS-issued `appKey` and the auth gateway base URL when creating the `SsoClient` in your
   front-end app.
2. **Session probe**: Call `client.probe()`; the client opens `auth.smis.itc.edu.kh/sso/probe?appKey=<key>` in a hidden/pop-up
   window.
3. **Existing session?**
   - If the gateway finds a valid refresh cookie, it silently issues a new access token for that `appKey` and posts it back to the
     opener; the popup closes and your app stores the session locally.
   - If not, the popup renders the login form where the user enters credentials for SMIS.
4. **Login**: On successful login, the gateway sets the refresh cookie, returns access+refresh tokens to the popup, and the client
   persists them in your app (e.g., `localStorage`).
5. **Authorization fetch**: With the access token, call `client.fetchAuthorizations()` to retrieve roles/permissions scoped to the
   `appKey`.
6. **Subsequent visits**: Your app uses stored tokens; when an access token expires, call `client.refresh()` to obtain a new one.
7. **Logout**: Call `client.logout()` to revoke the refresh token at the gateway and clear local session storage.
